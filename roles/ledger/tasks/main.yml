---
- name: "Ensure ruby is installed"
  pacman:
    name:
      - "git"
      - "ruby"
      - "libsodium"
    state: "present"
  become: yes

- name: "Download ledger repository"
  git:
    repo: "{{ ledger_repo }}"
    dest: "{{ ledger_directory }}"
    clone: yes
    update: yes
  register: ledger_repo

- name: "Install ledger"
  block:
    - command: "gem build ledger.gemspec"
      args:
        chdir: "{{ ledger_directory }}"
      register: ledger_gem
    - command: "gem install {{ ledger_gem.stdout | regex_findall('File: (.*)') | first }} --no-document"
      args:
        chdir: "{{ ledger_directory }}"
  rescue:
    - file: path="{{ ledger_directory }}" state="absent"
  when: ledger_repo is defined and ledger_repo is changed

- name: "Create folder for ledger configuration"
  file:
    path: "{{ ledger_config_directory }}"
    state: "directory"

- name: "Copy ledger configuration"
  template:
    src: "ledger.conf.j2"
    dest: "{{ ledger_config_directory }}/ledger.conf"
    mode: "0600"
