#!/usr/bin/env bash
set -eo pipefail
IFS=$'\n\t'

{{ ansible_managed | comment }}

repositories=(
  newsboat/newsboat samuelclay/NewsBlur Kozea/Radicale
  syncthing/syncthing saimn/sigal firehol/netdata
  mr-mig/every-programmer-should-know Nyr/openvpn-install
  OpenRCT2/OpenRCT2
)

base_dir="$HOME/Projects/open-source"

for repository in ${repositories[@]}; do
  repo_name=`echo $repository | awk -F'/' '{print $2}'`

  cd $base_dir

  if [ ! -d "$base_dir/$repo_name" ]; then
    git clone "git@github.com:cedricpim/$repo_name.git"
  fi

  cd $repo_name
  if ! git remote -v | grep -q "$repository"; then
    git remote add upstream "https://github.com/$repository.git"
  fi

  git fetch upstream
  git checkout master
  git merge upstream/master
  git push

  if [ "$1" == "--remove" ]; then
    rm -rf "$base_dir/$repo_name"
  fi
done
