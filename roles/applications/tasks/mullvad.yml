---
- name: "Install wireguard"
  pacman:
    name:
      - "wireguard-dkms"
      - "wireguard-tools"
      - "linux-headers"
  become: yes

- include_role:
    name: "yay"
  vars:
    pkg_name: "mullvad-vpn"

- name: "Create folder for Mullvad settings"
  file:
    path: "{{ mullvad_directory }}"
    state: "directory"
  become: yes

- name: "Copy Mullvad settings"
  template:
    src: "mullvad/settings.json.j2"
    dest: "{{ mullvad_directory }}/settings.json"
    mode: "0644"
  notify: "Restart Mullvad daemon"
  become: yes

- name: "Enable/start Mullvad daemon"
  systemd:
    name: "mullvad-daemon"
    state: "started"
    enabled: yes
  become: yes

- name: "Check if key is defined"
  command: "mullvad tunnel wireguard key check"
  failed_when: no
  changed_when: no
  register: mullvad_key_check
  become: yes

- name: "Generate key for Mullvad"
  command: "mullvad tunnel wireguard key generate"
  when: mullvad_key_check is defined and mullvad_key_check.stdout.find(mullvad_no_key) != -1
  become: yes

- name: "Set Mullvad to use Wireguard"
  command: "mullvad relay set tunnel wireguard any"
  become: yes
