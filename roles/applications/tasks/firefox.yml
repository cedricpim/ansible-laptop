---
- name: "install firefox"
  pacman:
    name: "firefox"
    state: present
  become: yes

- name: "check profiles.ini"
  stat:
    path: "{{ firefox_profiles }}/profiles.ini"
  register: st_profiles

- name: "find identifier of profile"
  shell: "grep Path= {{ firefox_profiles }}/profiles.ini | sed -r 's/Path=(.+)/\\1/'"
  register: profile
  changed_when: false
  when: st_profiles is defined and st_profiles.stat.islnk is defined

- name: "check handlers.json"
  stat:
    path: "{{ firefox_profiles }}/{{ profile.stdout }}/handlers.json"
  register: st_handlers
  when: profile is defined and not profile|skipped

- name: "add magnet handler"
  lineinfile:
    path: "{{ firefox_profiles }}/{{ profile.stdout }}/handlers.json"
    regexp: "(.*)\"schemes.*"
    line: '\1"schemes":{"magnet":{"action":2,"handlers":[{"name":"magnet","path":"{{ scripts_directory | regex_replace("~", ansible_env.HOME) }}/magnet"}]}}}'
    state: present
    backrefs: true
  when: st_handlers is defined and not st_handlers|skipped and st_handlers.stat.islnk is defined

- name: "check prefs.js"
  stat:
    path: "{{ firefox_profiles }}/{{ profile.stdout }}/prefs.js"
  register: st_prefs
  when: profile is defined and not profile|skipped

- name: "define options for Firefox"
  lineinfile:
    path: "{{ firefox_profiles }}/{{ profile.stdout }}/prefs.js"
    regexp: ".*{{ item.option }}.*"
    line: "user_pref(\"{{ item.option }}\", {{ item.value }});"
    state: present
  with_items:
    - {option: "network.protocol-handler.expose.magnet", value: "false"}
    - {option: "browser.tabs.loadDivertedInBackground", value: "true"}
    - {option: "network.http.sendRefererHeader", value: 0}
  when: st_prefs is defined and not st_prefs|skipped and st_prefs.stat.islnk is defined
