---
- name: "install firefox"
  pacman:
    name: "firefox"
    state: present
  become: yes

- include_role:
    name: "pacaur"
    tasks_from: "install"
  vars:
    pkg_name: "firefox-developer-edition"

- name: "check profiles.ini"
  stat:
    path: "{{ firefox_profiles_file }}/profiles.ini"
  register: st_profiles

- name: "find identifier of profile"
  shell: "grep -E {{ firefox_profile }} {{ firefox_profiles_file }}/profiles.ini | sed -r 's/Path=(.+)/\\1/'"
  register: profile
  changed_when: false
  when: st_profiles is defined and st_profiles.stat.islnk is defined

- name: "check handlers.json"
  stat:
    path: "{{ firefox_profiles_file }}/{{ profile.stdout }}/handlers.json"
  register: st_handlers
  when: profile is defined and not profile is skipped

- name: "add magnet handler"
  lineinfile:
    path: "{{ firefox_profiles_file }}/{{ profile.stdout }}/handlers.json"
    regexp: "(.*)\"schemes.*"
    line: '\1"schemes":{"magnet":{"action":2,"handlers":[{"name":"magnet","path":"{{ scripts_directory }}/magnet"}]}}}'
    state: present
    backrefs: true
  when: st_handlers is defined and not st_handlers is skipped and st_handlers.stat.islnk is defined

- name: "check prefs.js"
  stat:
    path: "{{ firefox_profiles_file }}/{{ profile.stdout }}/prefs.js"
  register: st_prefs
  when: profile is defined and not profile is skipped

- name: "define options for Firefox"
  lineinfile:
    path: "{{ firefox_profiles_file }}/{{ profile.stdout }}/prefs.js"
    regexp: ".*{{ item.option }}.*"
    line: "user_pref(\"{{ item.option }}\", {{ item.value }});"
    state: present
  with_items: "{{ firefox_options }}"
  when: st_prefs is defined and not st_prefs is skipped and st_prefs.stat.islnk is defined
