---
- name: "Install Yay dependencies"
  pacman:
    name: "git"
    state: "present"
  become: yes

- name: "Check if Yay is installed"
  command: "pacman -Q yay"
  failed_when: no
  changed_when: no
  register: aur_yay_check

- name: "Check if {{ pkg_name }} is installed"
  command: "pacman -Q {{ pkg_name }}"
  changed_when: no
  failed_when: no
  register: aur_package_check
  when: pkg_name is defined

- name: "Ensure yay user exists"
  user:
    name: "yay"
    state: "present"
  become: yes
  when:
    - pkg_name is defined
    - (aur_yay_check is defined and aur_yay_check.rc != 0) or (aur_package_check is defined and aur_package_check.rc != 0)

- name: "Install Yay"
  block:
    - file: path="~yay/.ansible/tmp" owner="yay" group="yay" state="directory"
    - tempfile: suffix="yay" state="directory"
      register: yay_tempdir
      become_user: "yay"
    - git: repo="{{ yay_repo }}" dest="{{ yay_tempdir.path }}" clone=yes update=yes
    - lineinfile: path="/etc/sudoers" insertbefore="BOF" line="yay ALL=(ALL) NOPASSWD{{ ':' }} ALL" validate="visudo -cf %s" state="present"
    - command: "makepkg -si --noconfirm"
      args:
        chdir: "{{ yay_tempdir.path }}"
      become_user: "yay"
  always:
    - lineinfile: path="/etc/sudoers" regexp='^yay' validate="visudo -cf %s" state="absent"
    - file: path="{{ yay_tempdir.path }}" state="absent"
  become: yes
  when:
    - pkg_name is defined
    - aur_yay_check is defined and aur_yay_check.rc != 0

- name: "Install {{ pkg_name }}"
  block:
    - lineinfile: path="/etc/sudoers" insertbefore="BOF" line="yay ALL=(ALL) NOPASSWD{{ ':' }} ALL" validate="visudo -cf %s" state="present"
    - command: "yay -Sy {{ pkg_name }} --needed --noconfirm"
      become_user: "yay"
  always:
    - lineinfile: path="/etc/sudoers" regexp='^yay' validate="visudo -cf %s" state="absent"
  become: yes
  when:
    - pkg_name is defined
    - aur_package_check is defined and aur_package_check.rc != 0
