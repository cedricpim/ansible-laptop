---
- name: "create initial groups"
  group:
    name: "{{ item }}"
    state: present
  with_items: "{{ users_groups }}"
  become: yes

- name: "create user {{ user_name }}"
  user:
    name: "{{ user_name }}"
    password: "{{ user_password }}"
    createhome: yes
    groups: "{{ users_groups }}"
    append: yes
    state: present
  become: yes

- name: "generate ssh key for {{ user_name }}"
  user:
    name: "{{ user_name }}"
    generate_ssh_key: yes
    ssh_key_bits: 4096
    ssh_key_file: ".ssh/id_rsa"
    ssh_key_passphrase: "{{ user_ssh_key_passphrase }}"
    ssh_key_comment: "{{ user_name }}"
  become: yes
