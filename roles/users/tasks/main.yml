---
- name: "create initial groups"
  group:
    name: "{{ item }}"
    state: "present"
  with_items: "{{ users_groups }}"
  become: yes

- name: "create users"
  user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    createhome: yes
    groups: "{{ users_groups }}"
    append: yes
    state: "present"
  with_items: "{{ users }}"
  no_log: yes
  become: yes

- name: "generate ssh keys"
  user:
    name: "{{ item.name }}"
    generate_ssh_key: yes
    ssh_key_bits: 4096
    ssh_key_file: ".ssh/id_rsa"
    ssh_key_passphrase: "{{ item.ssh_key_passphrase }}"
    ssh_key_comment: "{{ item.name }}"
  with_items: "{{ users }}"
  no_log: yes
  become: yes

- name: "setup ansible laptop project"
  block:
    - file: path="{{ ansible_laptop_directory }}" state="directory"
      with_items: "{{ users }}"
    - git: repo="{{ ansible_laptop_repo }}" dest="{{ ansible_laptop_dest }}" clone=yes update=no
      with_items: "{{ users }}"
    - replace: path="{{ ansible_laptop_dest }}/.git/config" regexp="{{ github_https_base }}" replace="{{ github_ssh_base }}"
      with_items: "{{ users }}"
  no_log: yes
  become: yes
  become_user: "{{ item.name }}"
