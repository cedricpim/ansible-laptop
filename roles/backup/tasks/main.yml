---
- include_role:
    name: "yay"
  vars:
    pkg_name: "duplicacy"

- name: "Install pexpect"
  pip:
    name: "pexpect"
    state: "latest"
  become: yes

- name: "Create folder for backups"
  file:
    path: "{{ backup_final_destination }}"
    owner: "{{ backup_main_user }}"
    group: "{{ backup_main_user }}"
    state: "directory"
    mode: "0755"
  become: yes

- name: "Retrieve list of installed packages"
  command: "yay -Qet"
  changed_when: false
  register: packages_list

- name: "Copy list of installed packages"
  copy:
    content: "{{ packages_list.stdout }}"
    dest: "{{ backup_final_destination }}/packages"
  become: yes
  when: packages_list is defined

- name: "Check if duplicacy repository has been initiated"
  stat:
    path: "{{ item.directory }}/.duplicacy"
  with_items: "{{ backup_configurations }}"
  no_log: yes
  become: yes
  register: duplicacy_repositories

- name: "Initiate the repositories for backups"
  expect:
    command: "duplicacy init -e -storage-name {{ item.item.name }} {{ item.item.name }} {{ backup_final_destination }}/{{ item.item.name }}"
    responses:
      password: "{{ item.item.password }}"
  args:
    chdir: "{{ item.item.directory }}"
  with_items: "{{ duplicacy_repositories.results }}"
  no_log: yes
  become: yes
  when:
    - duplicacy_repositories is defined
    - not item.stat.exists

- name: "Copy filters for backup"
  template:
    src: "filters.j2"
    dest: "{{ item.directory }}/.duplicacy/filters"
    mode: "0644"
  vars:
    lines: "{{ item.filters | default([]) }}"
  with_items: "{{ backup_configurations }}"
  no_log: yes
  become: yes

- name: "Ensure {{ backup_main_user }} permissions are set"
  file:
    path: "{{ backup_final_destination }}"
    owner: "{{ backup_main_user }}"
    group: "{{ backup_main_user }}"
    state: "directory"
    recurse: yes
  become: yes
