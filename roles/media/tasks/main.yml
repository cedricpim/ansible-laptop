---
- name: "Install CurlFtpFS and AutoFS"
  pacman:
    name:
      - "curlftpfs"
      - "autofs"
    state: "present"
  become: yes

- name: "Always load fuse module"
  lineinfile:
    path: "{{ modprobe_directory }}/fuse.conf"
    line: "fuse"
    state: "present"
    create: yes
  become: yes

- name: "Copy AutoFS configuration"
  template:
    src: "ftp.autofs.j2"
    dest: "{{ autofs_directory }}/auto.master.d/ftp.autofs"
    mode: "0644"
  become: yes

- name: "Copy FTP configuration for AutoFS"
  template:
    src: "auto.ftp.j2"
    dest: "{{ autofs_directory }}/auto.ftp"
    mode: "0644"
  become: yes

- name: "Set access permissions to the FTP media"
  template:
    src: "netrc.j2"
    dest: "~root/.netrc"
    mode: "0600"
  become: yes

- name: "Copy mounting/unmounting scripts for curl"
  template:
    src: "scripts/{{ item }}.j2"
    dest: "/sbin/{{ item }}"
    owner: "root"
    group: "root"
    mode: "0755"
  with_items:
    - "mount.curl"
    - "umount.curl"
  become: yes

- name: "Enable/start service for AutoFS"
  systemd:
    name: "autofs"
    state: "started"
    enabled: yes
  become: yes
