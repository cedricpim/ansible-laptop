---
- include_role:
    name: "pacaur"
    tasks_from: "install"
  with_items:
    - "rxvt-unicode-patched"
    - "urxvt-font-size-git"
  loop_control:
    loop_var: "pkg_name"

- name: "Create folder for urxvt icon"
  file:
    path: "{{ urxvt_icon_dest }}"
    state: "directory"

- name: "Copy urxvt icon"
  copy:
    src: "urxvt.png"
    dest: "{{ urxvt_icon_dest }}"
    mode: "0644"

- name: "Create folder for urxvt extra configurations"
  file:
    path: "{{ urxvt_directory }}"
    state: "directory"

- name: "Copy urxvt extra configurations"
  template:
    src: "{{ item.file }}.j2"
    dest: "{{ urxvt_directory }}/{{ item.file }}"
    mode: "{{ item.mode }}"
  with_items:
    - { file: "colorscheme", mode: "0600" }
    - { file: "urxvtopen", mode: "0700" }
  notify: "Load configuration"

- name: "Install python-psutil for dconf"
  pacman:
    name: "python-psutil"
    state: "present"
  become: yes

- name: "Set global shortcut for urxvt"
  dconf:
    key: "{{ dconf_custom_keybindings }}/{{ urxvt_shortcut_custom }}/{{ item.key }}"
    value: "{{ item.value | regex_replace('~', ansible_env.HOME) }}"
    state: "present"
  with_items: "{{ urxvt_shortcut_configuration }}"

- name: "Read current keybindings"
  dconf:
    key: "{{ dconf_custom_keybindings }}"
    state: "read"
  register: custom_urxvt

- name: "Create list with new keybinding"
  dconf:
    key: "{{ dconf_custom_keybindings }}"
    value: "[{{ dconf_urxvt_custom_key }}]"
    state: "present"
  when:
    - custom_urxvt is defined
    - custom_urxvt.value is none

- name: "Add new keybinding to existing list"
  dconf:
    key: "{{ dconf_custom_keybindings }}"
    value: "[{{ custom_urxvt.value | regex_findall('\\[(.*)\\]') | first }}, {{ dconf_urxvt_custom_key }}]"
    state: "present"
  when:
    - custom_urxvt is defined
    - custom_urxvt.value is not none
    - urxvt_shortcut_custom not in custom_urxvt.value

- name: "Copy urxvt configuration"
  template:
    src: "Xresources.j2"
    dest: "~/.Xresources"
    mode: "0600"
  notify: "Load configuration"

- name: "Update urxvt application icon"
  replace:
    path: "{{ urxvt_desktop }}/{{ item }}.desktop"
    regexp: "^Icon=.*"
    replace: "Icon=urxvt"
    backup: no
  with_items:
    - "urxvt"
    - "urxvtc"
    - "urxvt-tabbed"
  become: yes
