---
- name: "Install network tools"
  pacman:
    name:
      - "iw"
      - "iwd"
      - "wpa_supplicant"
      - "bluez"
      - "connman"
      - "ntp"
      - "openresolv"
      - "wireguard-dkms"
      - "wireguard-tools"
      - "linux-headers"
    state: "present"
  become: yes

- include_role:
    name: "zsh"
    tasks_from: "scripts"
  vars:
    script: "wgq"

- name: "Copy resolvconf configuration"
  template:
    src: "resolvconf/resolvconf.conf.j2"
    dest: "/etc/resolvconf.conf"
    mode: "0644"
  become: yes
  notify: "Rebuild resolvconf configuration"

- name: "Create folder for systemd ConnMan"
  file:
    path: "{{ systemd_directory }}/connman.service.d"
    state: "directory"
    mode: "0755"
  become: yes

- name: "Copy ConnMan overriding configuration for systemd"
  template:
    src: "connman/override.conf.j2"
    dest: "{{ systemd_directory }}/connman.service.d/override.conf"
    mode: "0644"
  become: yes

- name: "Enable/start service for ConnMan"
  systemd:
    name: "connman"
    state: "started"
    enabled: yes
    daemon_reload: yes
  become: yes

- name: "Enable/start service for NTP"
  systemd:
    name: "ntpd"
    state: "started"
    enabled: yes
  become: yes

- name: "Connect to WI-FI"
  block:
    - command: "ip link set {{ network_interface }} up"
    - command: "wpa_supplicant -B -i {{ network_interface }} -C <(wpa_passphrase {{ network_name }} {{ network_passphrase }})"
    - command: "dhcpcd {{ network_interface }}"
  become: yes
  when:
    - network is defined
    - network_interface is defined
    - network_name is defined
    - network_passphrase is defined
