---
- name: "Install power management tools"
  pacman:
    name:
      - "powertop"
      - "tlp"
    state: "present"

- include_role:
    name: "yay"
  vars:
    pkg_name: "watchdog"

- name: "Add Nvidia driver to blacklist"
  lineinfile:
    path: "/etc/default/tlp"
    regexp: "RUNTIME_PM_BLACKLIST"
    line: 'RUNTIME_PM_BLACKLIST="{{ gpu_address }}"'
    state: "present"

- name: "Start and enable TLP services"
  service:
    name: "{{ item }}"
    enabled: yes
  with_items:
    - "tlp"
    - "tlp-sleep"

- name: "Stop and mask services conflicting with TLP"
  service:
    name: "{{ item }}"
    state: "stopped"
    masked: yes
  with_items:
    - "systemd-rfkill"
    - "systemd-rfkill.socket"

- name: "Copy powertop service configuration"
  template:
    src: "powertop.service.j2"
    dest: "{{ systemd_directory }}/powertop.service"
    mode: "0644"

- name: "Enable system services"
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: "started"
  with_items:
    - "watchdog"
    - "fstrim.timer"
    - "powertop"
