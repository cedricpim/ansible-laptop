---
- name: "Install power management tools"
  pacman:
    name:
      - "powertop"
      - "tlp"
    state: "present"

- include_role:
    name: "yay"
  vars:
    pkg_name: "watchdog"

- name: "Add Nvidia driver to blacklist"
  lineinfile:
    path: "/etc/default/tlp"
    regexp: "RUNTIME_PM_BLACKLIST"
    line: 'RUNTIME_PM_BLACKLIST="{{ gpu_address }}"'
    state: "present"

- name: "Disable BTRFS optimization"
  lineinfile:
    path: "/etc/default/tlp"
    regexp: "SATA_LINKPWR_ON_BAT"
    line: 'SATA_LINKPWR_ON_BAT="max_performance"'
    state: "present"

- name: "Start and enable TLP services"
  service:
    name: "{{ item }}"
    enabled: yes
  with_items:
    - "tlp"
    - "tlp-sleep"

- name: "Stop and mask services conflicting with TLP"
  service:
    name: "{{ item }}"
    state: "stopped"
    masked: yes
  with_items:
    - "systemd-rfkill"
    - "systemd-rfkill.socket"

- name: "Add instructions related to powertop"
  lineinfile:
    path: "~{{ users[0].name }}/todo"
    regexp: "{{ item }}"
    line: "{{ item }}"
    state: "present"
    create: yes
    owner: "{{ users[0].name }}"
    group: "{{ users[0].name }}"
  with_items:
    - "sudo powertop --calibrate"
    - "sudo powertop --auto-tune"

- name: "Enable system services"
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: "started"
  with_items:
    - "watchdog"
    - "fstrim.timer"
