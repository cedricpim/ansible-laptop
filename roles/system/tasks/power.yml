---
- name: "Install power management tools"
  pacman:
    name:
      - "powertop"
      - "tlp"
      - "polkit"
      - "xautolock"
      - "xss-lock"
    state: "present"
  become: yes

- include_role:
    name: "yay"
  with_items:
    - "i3lock-blur"
    - "watchdog"
  loop_control:
    loop_var: "pkg_name"

- name: "Add Nvidia driver to blacklist"
  lineinfile:
    path: "/etc/default/tlp"
    regexp: "RUNTIME_PM_BLACKLIST"
    line: 'RUNTIME_PM_BLACKLIST="{{ gpu_address }}"'
    state: "present"
  become: yes

- name: "Disable BTRFS optimization"
  lineinfile:
    path: "/etc/default/tlp"
    regexp: "SATA_LINKPWR_ON_BAT"
    line: 'SATA_LINKPWR_ON_BAT="max_performance"'
    state: "present"
  become: yes

- name: "Start and enable TLP services"
  service:
    name: "{{ item }}"
    enabled: yes
  with_items:
    - "tlp"
    - "tlp-sleep"
  become: yes

- name: "Stop and mask services conflicting with TLP"
  service:
    name: "{{ item }}"
    state: "stopped"
    masked: yes
  with_items:
    - "systemd-rfkill"
    - "systemd-rfkill.socket"
  become: yes

- name: "Add instructions related to powertop"
  lineinfile:
    path: "~{{ users[0].name }}/todo"
    regexp: "{{ item }}"
    line: "{{ item }}"
    state: "present"
    create: yes
    owner: "{{ users[0].name }}"
    group: "{{ users[0].name }}"
  with_items:
    - "sudo powertop --calibrate"
    - "sudo powertop --auto-tune"
  become: yes

- name: "Enable system services"
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: "started"
  with_items:
    - "watchdog"
    - "fstrim.timer"
  become: yes

- name: "Create folder for systemd configuration"
  file:
    path: "{{ systemd_directory }}"
    state: "directory"
    mode: "0755"
  become: yes

- name: "Copy systemd login configuration"
  template:
    src: "logind.conf.j2"
    dest: "{{ systemd_directory }}/logind.conf"
    mode: "0644"
  become: yes
