---
- name: "Install grub and efibootmgr"
  pacman:
    name:
      - "grub"
      - "efibootmgr"
      - "intel-ucode"
    state: "present"

- name: "Copy entry for arch"
  block:
    - file: path="/boot/loader/entries" state="directory"
    - command: "lsblk -n -o UUID /dev/sda2"
      changed_when: no
      register: crypto_uuid
    - template: src="arch.conf.j2" dest="/boot/loader/entries/arch.conf"
      vars:
        uuid: "{{ crypto_uuid.stdout_lines | first }}"

- name: "Set cryptdevice"
  lineinfile:
    path: "/etc/default/grub"
    regexp: '^GRUB_CMDLINE_LINUX='
    line: 'GRUB_CMDLINE_LINUX="cryptdevice=/dev/sda2:cryptolvm"'
  notify: "Create grub configuration"

- name: "Run grub installation"
  command: "grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB"
  notify: "Create grub configuration"

- name: "Set HOOKS for mkinitcpio"
  lineinfile:
    path: "/etc/mkinitcpio.conf"
    regexp: '^HOOKS='
    line: 'HOOKS=(base udev autodetect modconf block filesystems keyboard fsck keymap encrypt lvm2)'
  notify: "Create mkinitcpio configuration"

# - name: "Hide grub"
#   lineinfile:
#     path: "/etc/default/grub"
#     regexp: '^GRUB_FORCE_HIDDEN_MENU='
#     line: 'GRUB_FORCE_HIDDEN_MENU="true"'
#   notify: "Create grub configuration"

# - name: "Download grub script for SHIFT key"
#   get_url:
#     url: "{{ grub_shift_script }}"
#     dest: "/etc/grub.d/31_hold_shift"
#     mode: 0744
#   notify: "Create grub configuration"

# - name: "Install systemd-boot"
#   command: "bootctl --path=/boot install"

# - name: "change password for root user"
#   user:
#     name: "root"
#     password: "{{ password_hash.stdout_lines[-1] }}"

# - include_role:
#     name: "yay"
#   vars:
#     pkg_name: "systemd-boot-pacman-hook"
