---
- include_role:
    name: "pacaur"
    tasks_from: "install"
  vars:
    pkg_name: "journal-triggerd"
  become: yes
  become_user: "{{ users[0].name }}"

- name: "copy journal error logger"
  template:
    src: "journal-triggerd/journal-logger.j2"
    dest: "/usr/bin/journal-logger"
    owner: "root"
    group: "root"
    mode: "0755"
  become: yes

- name: "check log file status"
  stat:
    path: "{{ journal_triggerd_log }}"
  register: journal_log_stat
  become: yes

- name: "ensure log file exists"
  file:
    path: "{{ journal_triggerd_log }}"
    owner: "root"
    group: "root"
    mode: "0644"
    state: "touch"
  become: yes
  when: journal_log_stat is defined and journal_log_stat.stat.islnk is not defined

- name: "copy journal-triggerd configuration"
  template:
    src: "journal-triggerd/failed.rule.j2"
    dest: "{{ journal_triggerd_directory }}/failed.rule"
    owner: "root"
    group: "root"
    mode: "0644"
  become: yes
  notify: "restart journal-triggerd configuration"

- name: "enable/start journal-triggerd service"
  systemd:
    name: "journal-triggerd"
    state: "started"
    enabled: yes
  become: yes

- name: "set maximum size for journal logs"
  lineinfile:
    path: "/etc/systemd/journald.conf"
    regexp: "SystemMaxUse="
    line: "SystemMaxUse={{ journald_system_max_use }}"
    state: "present"
  become: yes
  notify: "restart systemd-journal"
