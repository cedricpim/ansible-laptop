---
- hosts: local

  vars_files:
    - "../vaulted_vars/system.yml"
    - "../vars/system.yml"

  tasks:
    - name: "Retrieve list of installed packages"
      command: "yay -Qet"
      changed_when: false
      register: packages_list

    - name: "Copy list of installed packages to both backups"
      copy:
        content: "{{ packages_list.stdout }}"
        dest: "{{ backup_final_destination }}/packages"
      become: yes
      when: packages_list is defined

    - name: "Copy list of installed packages to secondary backup"
      command: "cp --force {{ backup_final_destination }}/packages {{ backup_secondary_destination }}"
      become: yes

    - name: "Execute backup"
      expect:
        command: "duplicacy backup"
        responses:
          password: "{{ item.password }}"
        timeout: null
      args:
        chdir: "{{ item.directory }}"
      with_items: "{{ backup_configurations }}"
      become: yes

    - name: "Create secondary backup"
      expect:
        command: "duplicacy copy -from {{ item.name }} -to {{ item.name }}-snd"
        responses:
          password: "{{ item.password }}"
        timeout: null
      args:
        chdir: "{{ item.directory }}"
      with_items: "{{ backup_configurations }}"
      become: yes

    - name: "Ensure {{ backup_main_user }} permissions are set"
      file:
        path: "{{ backup_final_destination }}"
        owner: "{{ backup_main_user }}"
        group: "{{ backup_main_user }}"
        state: "directory"
        recurse: yes
      become: yes
